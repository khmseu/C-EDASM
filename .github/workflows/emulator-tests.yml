name: Emulator Tests

on:
    push:
        branches: [main, develop, "copilot/**"]
    pull_request:
        branches: [main, develop]
    workflow_dispatch:

jobs:
    emulator-test:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  submodules: recursive

            - name: Install dependencies
              run: |
                  sudo apt-get update
                  sudo apt-get install -y cmake g++ libncurses5-dev golang-go

            - name: Install MAME
              run: |
                  sudo apt-get install -y mame
                  mame -version

            - name: Fetch Apple II ROMs (emularity-bios)
              run: |
                  ROM_DIR="$HOME/mame/roms"
                  mkdir -p "$ROM_DIR"
                  curl -L https://github.com/internetarchive/emularity-bios/raw/main/apple2e.zip -o "$ROM_DIR/apple2e.zip"
                  curl -L https://github.com/internetarchive/emularity-bios/raw/main/apple2gs.zip -o "$ROM_DIR/apple2gs.zip"
                  mkdir -p "$HOME/.mame"
                  ln -s "$ROM_DIR" "$HOME/.mame/roms" 2>/dev/null || true
                  mame -rompath "$ROM_DIR" -verifyroms apple2gs || mame -verifyroms apple2gs

            - name: Install cadius
              run: |
                  # Install build dependencies
                  sudo apt-get update
                  sudo apt-get install -y build-essential cmake git

                  # Build cadius from submodule
                  cd third_party/cadius
                  make

            - name: Verify cadius installation
              run: |
                  # Check if cadius was built successfully
                  ./third_party/cadius/cadius --help || echo "cadius built (help command may not be available)"

            - name: Configure C-EDASM
              run: ./scripts/configure.sh

            - name: Build C-EDASM
              run: ./scripts/build.sh

            - name: Run C-EDASM tests
              run: |
                  cd build
                  ctest --output-on-failure

            - name: Test emulator setup (boot test)
              run: |
                  export PATH="$PATH:$HOME/go/bin"
                  ./scripts/run_emulator_test.sh boot
              continue-on-error: true # Expected to skip in CI without display/GPU

            - name: Upload test artifacts
              if: always()
              uses: actions/upload-artifact@v4
              with:
                  name: emulator-test-logs
                  path: tmp/edasm-emulator-test/
                  retention-days: 7

            - name: Summary
              if: always()
              run: |
                  echo "## Emulator Test Status" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "ℹ️ **Note**: Emulator tests require display/GPU hardware support." >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "MAME-based tests are expected to be skipped in standard GitHub Actions runners." >> $GITHUB_STEP_SUMMARY
                  echo "Tests will run successfully on systems with proper graphics support." >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "For details and manual testing instructions, see \`tests/emulator/README.md\`." >> $GITHUB_STEP_SUMMARY
